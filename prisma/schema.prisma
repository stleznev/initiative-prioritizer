// This Prisma schema defines the database models for the initiative prioritizer.
// It closely follows the specification provided by the user.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Dataset {
  id        String   @id @default(uuid())
  version   String
  createdAt DateTime @default(now())
  isActive  Boolean  @default(false)
  initiatives Initiative[]
  votes       Vote[]
  userStates  UserState[]
}

model Initiative {
  id               String   @id
  businessStream   String
  number           String
  initiativeName   String
  initiativeGroup  String
  importantStatus  String
  urgentStatus     String
  cdekStatus       String
  inProcessStatus  String
  meta             Json?
  datasetId        String
  dataset          Dataset  @relation(fields: [datasetId], references: [id])
  votesLeft        Vote[]   @relation("VoteLeft")
  votesRight       Vote[]   @relation("VoteRight")
  votesWinner      Vote[]   @relation("VoteWinner")
}

model User {
  id        String    @id @default(uuid())
  cookieId  String?   @unique
  name      String
  createdAt DateTime  @default(now())
  votes     Vote[]
  states    UserState[]
}

model UserState {
  id            String   @id @default(uuid())
  userId        String
  datasetId     String
  orderedIds    String[]
  cursorId      String?
  low           Int?
  high          Int?
  currentIndex  Int?
  done          Boolean  @default(false)
  historyPointer Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])
  dataset       Dataset  @relation(fields: [datasetId], references: [id])

  @@unique([userId, datasetId])
}

model Vote {
  id        Int      @id @default(autoincrement())
  userId    String
  datasetId String
  leftId    String
  rightId   String
  winnerId  String
  createdAt DateTime @default(now())
  orderIndex Int

  user     User     @relation(fields: [userId], references: [id])
  dataset  Dataset  @relation(fields: [datasetId], references: [id])
  left     Initiative @relation("VoteLeft", fields: [leftId], references: [id])
  right    Initiative @relation("VoteRight", fields: [rightId], references: [id])
  winner   Initiative @relation("VoteWinner", fields: [winnerId], references: [id])

  @@index([datasetId])
  @@index([userId, datasetId])
}
