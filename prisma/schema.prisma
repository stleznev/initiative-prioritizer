// Prisma schema for the Initiative Prioritizer application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Dataset {
  id         String      @id @default(uuid())
  version    String      @unique
  createdAt  DateTime    @default(now())
  isActive   Boolean     @default(false)
  initiatives Initiative[]
  userStates UserState[]
  votes      Vote[]
}

model Initiative {
  id              String     @id
  businessStream  String
  number          String
  initiativeName  String
  initiativeGroup String
  importantStatus String
  urgentStatus    String
  cdekStatus      String
  inProcessStatus String
  datasetId       String
  meta            Json?
  dataset         Dataset    @relation(fields: [datasetId], references: [id])
  votesLeft       Vote[]     @relation("VoteLeft")
  votesRight      Vote[]     @relation("VoteRight")
  votesWinner     Vote[]     @relation("VoteWinner")
}

model User {
  id         String     @id
  name       String
  createdAt  DateTime   @default(now())
  states     UserState[]
  votes      Vote[]
}

model UserState {
  userId         String
  datasetId      String
  orderedIds     String[]   @default([])
  cursorId       String?
  low            Int        @default(0)
  high           Int        @default(0)
  currentIndex   Int?
  done           Boolean    @default(false)
  historyPointer Int?
  user           User       @relation(fields: [userId], references: [id])
  dataset        Dataset    @relation(fields: [datasetId], references: [id])
  @@id([userId, datasetId])
}

model Vote {
  id         Int        @id @default(autoincrement())
  userId     String
  datasetId  String
  leftId     String
  rightId    String
  winnerId   String
  createdAt  DateTime   @default(now())
  orderIndex Int
  user       User       @relation(fields: [userId], references: [id])
  dataset    Dataset    @relation(fields: [datasetId], references: [id])
  left       Initiative @relation("VoteLeft", fields: [leftId], references: [id])
  right      Initiative @relation("VoteRight", fields: [rightId], references: [id])
  winner     Initiative @relation("VoteWinner", fields: [winnerId], references: [id])

  @@index([datasetId])
  @@index([userId, datasetId])
  @@unique([userId, datasetId, orderIndex], name: "userId_datasetId_orderIndex")
}
